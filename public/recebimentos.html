<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Recebimentos ‚Äî Loja Doces</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { API, toast, money, debounce } from "./assets/app.js";
    <script type="module">
  import { requireAuth, getUser, signOut, supabase } from "./assets/auth.js";
  await requireAuth();
  const { data: { session } } = await supabase.auth.getSession();
  window.SESSION = session;
  window.addEventListener("DOMContentLoaded", async ()=>{
    const user = await getUser(); if(user) document.querySelector("#user-email").textContent = user.email;
    const btn = document.querySelector("#btn-logout"); if(btn) btn.onclick = signOut;
  });
</script>

    let cliente=null, titulos=[], pixChaves=[];
    async function carregarChavesPix(){ try{ pixChaves=await API.get('pix/chaves', {}, window.SESSION?.access_token); const sel=document.querySelector('#pix_chave'); sel.innerHTML=pixChaves.map(c=>`<option value="${c.id}">${c.apelido||c.chave}</option>`).join(''); }catch{} }
    async function buscarCliente(q){ if(!q||q.length<2) return []; return await API.get('clientes', { search:q, limit:10 }, window.SESSION?.access_token); }
    function autocompleteClientes(){ const box=document.querySelector('#cliente_busca'); const wrap=document.querySelector('#sugCli'); const ul=document.querySelector('#sugCli ul'); const update=debounce(async()=>{ const arr=await buscarCliente(box.value.trim()); ul.innerHTML=''; if(!arr.length){ wrap.classList.add('hidden'); return; } arr.forEach(c=>{ const li=document.createElement('li'); li.className='px-3 py-2 hover:bg-slate-100 cursor-pointer'; li.textContent=`$${c.nome} $${c.doc?`‚Äî ${c.doc}`:''}`; li.onclick=()=>{ selecionarCliente(c); wrap.classList.add('hidden'); box.value=''; }; ul.appendChild(li); }); wrap.classList.remove('hidden'); },250); box.addEventListener('input',update); box.addEventListener('blur',()=> setTimeout(()=>wrap.classList.add('hidden'),120)); }
    async function selecionarCliente(c){ cliente=c; document.querySelector('#cliente_sel').textContent=c.nome; await carregarTitulos(); }
    async function carregarTitulos(){ if(!cliente) return; titulos=await API.get('recebimentos/abertos', { cliente_id:cliente.id }, window.SESSION?.access_token); const tbody=document.querySelector('#grid tbody'); tbody.innerHTML=''; titulos.forEach(t=>{ const tr=document.createElement('tr'); tr.className='border-b last:border-0'; tr.innerHTML=`<td class="py-2 px-3">${new Date(t.data).toLocaleString('pt-BR')}</td><td class="py-2 px-3">${t.venda_id}</td><td class="py-2 px-3 text-right">${money(t.total)}</td><td class="py-2 px-3 text-right font-medium">${money(t.saldo)}</td><td class="py-2 px-3 text-right"><button class="px-3 py-1.5 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700" data-id="${t.id}" data-saldo="${t.saldo}">Receber</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('button').forEach(b=> b.onclick=()=> abrirModalReceber(b.dataset.id, Number(b.dataset.saldo)||0)); document.querySelector('#count').textContent=titulos.length; }
    function abrirModalReceber(titulo_id, saldo){ const dlg=document.querySelector('#dlg'); dlg.classList.remove('hidden'); dlg.dataset.titulo=titulo_id; document.querySelector('#valor').value=String(saldo.toFixed(2)).replace('.',','); document.querySelector('#forma').value='DINHEIRO'; document.querySelector('#pix_area').classList.add('hidden'); document.querySelector('#brcode').value=''; }
    async function gerarPix(){ const titulo_id=document.querySelector('#dlg').dataset.titulo; const chave_id=document.querySelector('#pix_chave').value; const valor=Number(document.querySelector('#valor').value.replace('.','').replace(',','.'))||0; const { brcode } = await API.post('pix/brcode', { titulo_id, chave_id, valor }, window.SESSION?.access_token); document.querySelector('#brcode').value=brcode||''; toast('PIX Copia e Cola gerado!'); }
    async function confirmarRecebimento(){ const titulo_id=document.querySelector('#dlg').dataset.titulo; const forma=document.querySelector('#forma').value; const valor=Number(document.querySelector('#valor').value.replace('.','').replace(',','.'))||0; const chave_id= forma==='PIX'? document.querySelector('#pix_chave').value : null; const brcode= forma==='PIX'? document.querySelector('#brcode').value : null; await API.post('recebimentos', { titulo_id, forma, valor, chave_id, brcode }, window.SESSION?.access_token); toast('Recebimento registrado!'); document.querySelector('#dlg').classList.add('hidden'); await carregarTitulos(); }
    window.addEventListener('DOMContentLoaded',()=>{ autocompleteClientes(); carregarChavesPix(); document.querySelector('#forma').addEventListener('change',(e)=> document.querySelector('#pix_area').classList.toggle('hidden', e.target.value!=='PIX')); document.querySelector('#btn-gerar-pix').addEventListener('click', gerarPix); document.querySelector('#btn-confirmar').addEventListener('click', confirmarRecebimento); document.querySelector('#btn-fechar').addEventListener('click', ()=> document.querySelector('#dlg').classList.add('hidden')); });
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
  <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
    <a href="/" class="font-semibold">üç¨ Loja Doces</a>
    <nav class="flex items-center gap-3 text-sm">
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100" href="/produtos.html">Produtos</a>
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100" href="/vendas.html">Vendas</a>
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100" href="/recebimentos.html">Recebimentos</a>
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100" href="/relatorios.html">Relat√≥rios</a>
      <span id="user-email" class="text-slate-500"></span>
      <button id="btn-logout" class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200">Sair</button>
    </nav>
  </div>
</header>

  <main class="mx-auto max-w-6xl px-4 py-6 grid lg:grid-cols-3 gap-6">
    <section class="lg:col-span-1">
      <div class="bg-white border rounded-2xl p-5 shadow-sm relative">
        <h2 class="font-medium mb-4">Cliente</h2>
        <div class="relative">
          <input id="cliente_busca" placeholder="Digite nome/CPF/CNPJ..." class="w-full px-3 py-2 border rounded-xl outline-none focus:ring">
          <div id="sugCli" class="hidden absolute w-full mt-1 bg-white border rounded-xl shadow"><ul class="max-h-64 overflow-auto"></ul></div>
        </div>
        <p class="mt-3 text-sm text-slate-500">Selecionado: <span id="cliente_sel" class="font-medium">‚Äî</span></p>
      </div>
    </section>
    <section class="lg:col-span-2">
      <div class="bg-white border rounded-2xl p-5 shadow-sm">
        <div class="flex items-center justify-between mb-3"><h2 class="font-medium">T√≠tulos em aberto <span id="count" class="text-slate-400 text-sm">0</span></h2></div>
        <div class="overflow-auto">
          <table id="grid" class="w-full text-sm">
            <thead class="text-left text-slate-500"><tr><th class="py-2 px-3 font-normal">Data</th><th class="py-2 px-3 font-normal">Venda</th><th class="py-2 px-3 font-normal text-right">Total</th><th class="py-2 px-3 font-normal text-right">Saldo</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
  <div id="dlg" class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg border shadow-xl">
      <div class="p-5 border-b flex items-center justify-between"><h3 class="font-semibold">Registrar recebimento</h3><button id="btn-fechar" class="text-slate-400 hover:text-slate-600">‚úï</button></div>
      <div class="p-5 grid gap-4">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm text-slate-500">Forma</label><select id="forma" class="w-full mt-1 px-3 py-2 border rounded-xl"><option>DINHEIRO</option><option>PIX</option></select></div>
          <div><label class="text-sm text-slate-500">Valor</label><input id="valor" inputmode="decimal" class="w-full mt-1 px-3 py-2 border rounded-xl" placeholder="0,00"></div>
        </div>
        <div id="pix_area" class="hidden grid gap-3">
          <div><label class="text-sm text-slate-500">Chave PIX</label><select id="pix_chave" class="w-full mt-1 px-3 py-2 border rounded-xl"></select></div>
          <div class="flex gap-2 items-end"><button id="btn-gerar-pix" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl">Gerar PIX</button></div>
          <div><label class="text-sm text-slate-500">PIX Copia e Cola</label><textarea id="brcode" rows="3" class="w-full mt-1 px-3 py-2 border rounded-xl font-mono text-xs"></textarea></div>
        </div>
      </div>
      <div class="p-5 border-t text-right"><button id="btn-confirmar" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl">Confirmar</button></div>
    </div>
  </div>
</body>
</html>
