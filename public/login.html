<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entrar — SGV PDV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .bg-grid{background-image:radial-gradient(circle at 1px 1px,rgba(255,255,255,.15) 1px,transparent 0);background-size:22px 22px}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-violet-600 via-indigo-600 to-sky-600 text-white">
  <div class="absolute inset-0 bg-grid opacity-40"></div>

  <main class="relative min-h-screen grid place-items-center p-4">
    <div class="w-full max-w-md backdrop-blur-xl bg-white/10 border border-white/20 rounded-3xl shadow-2xl p-6">
      <!-- Cabeçalho -->
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-2xl bg-white/20 grid place-items-center text-xl">🍬</div>
        <div>
          <div class="font-semibold">Doces da Maria</div>
          <div class="text-white/70 text-sm">Acesso restrito</div>
        </div>
      </div>

      <!-- Formulário -->
      <form id="formLogin" class="grid gap-3" novalidate>
        <div>
          <label for="email" class="text-sm text-white/80">E-mail</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="username" required
                 class="w-full mt-1 px-3 py-2 rounded-xl bg-white/90 text-slate-800 outline-none focus:ring-4 focus:ring-white/40">
        </div>

        <div>
          <label for="senha" class="text-sm text-white/80">Senha</label>
          <div class="relative mt-1">
            <input id="senha" name="senha" type="password" autocomplete="current-password" required
                   class="w-full px-3 py-2 rounded-xl bg-white/90 text-slate-800 outline-none focus:ring-4 focus:ring-white/40 pr-12">
            <button type="button" id="btn-toggle"
                    class="absolute inset-y-0 right-2 my-auto px-2 rounded-md text-slate-700/70 hover:text-slate-900 focus:outline-none"
                    title="Mostrar/ocultar senha">👁️</button>
          </div>
        </div>

        <button type="submit" id="btn-login"
                class="mt-2 py-2 rounded-xl bg-white text-slate-900 hover:bg-slate-100 font-medium disabled:opacity-70 disabled:cursor-not-allowed">
          Entrar
        </button>
      </form>

      <div class="flex items-center justify-between mt-3 text-sm">
        <a id="link-reset" href="#" class="text-white/80 hover:text-white">Esqueci minha senha</a>
        <span class="text-white/50">v1.0</span>
      </div>
    </div>
  </main>

  <!-- Lógica -->
  <script type="module">
    import { supabase } from "./assets/auth.js";
    import { toast } from "./assets/app.js";

    // Se já estiver logado, redireciona direto
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        const next = new URLSearchParams(location.search).get('next') || '/dashboard';
        location.replace(next);
      }
    })();

    // Mostrar / ocultar senha
    function bindTogglePassword() {
      const input = document.getElementById('senha');
      const btn = document.getElementById('btn-toggle');
      if (!input || !btn) return;
      btn.addEventListener('click', () => {
        input.type = input.type === 'password' ? 'text' : 'password';
        btn.textContent = input.type === 'password' ? '👁️' : '🙈';
      });
    }

    async function doLogin(e) {
      e.preventDefault();
      const form = e.currentTarget;
      const btn = document.getElementById('btn-login');
      const email = form.email.value.trim();
      const password = form.senha.value;

      if (!email || !password) { toast('Preencha e-mail e senha.', 'err'); return; }

      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = 'Entrando…';

      try {
        const r = await fetch('/api/auth-proxy/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const raw = await r.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = null; }

        if (!r.ok) {
          const msg = data?.error_description || data?.error || data?.message || raw || 'Falha de login';
          console.error('LOGIN ERROR', { status: r.status, raw });
          toast(`${msg} (status ${r.status})`, 'err');
          return;
        }

        if (!data?.access_token || !data?.refresh_token) {
          console.error('LOGIN: resposta inesperada', raw);
          toast('Resposta inesperada do servidor.', 'err');
          return;
        }

        await supabase.auth.setSession({
          access_token: data.access_token,
          refresh_token: data.refresh_token
        });

        const next = new URLSearchParams(location.search).get('next') || '/dashboard';
        if (next.startsWith('/')) {
          location.href = next;
        } else {
          location.href = '/dashboard';
        }

      } catch (err) {
        console.error(err);
        toast('Rede/Proxy indisponível', 'err');
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    async function handleReset(e) {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      if (!email) { toast('Digite seu e-mail primeiro.', 'err'); return; }
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: location.origin + '/login.html'
        });
        if (error) throw error;
        toast('Se o e-mail existir, enviaremos instruções.', 'ok');
      } catch (err) {
        console.error(err);
        toast('Não foi possível enviar o e-mail agora.', 'err');
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.querySelector('#formLogin').addEventListener('submit', doLogin);
      document.querySelector('#link-reset').addEventListener('click', handleReset);
      bindTogglePassword();
      document.getElementById('email')?.focus();
    });
  </script>