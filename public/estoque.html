<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Estoque ‚Äî SGV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="./assets/guard.js"></script>
  <script type="module">
    import { API, toast, money, debounce } from "./assets/app.js";

    let lookup = [];
    async function carregarSaldos(search=''){
      const data = await API.get('estoque/saldos', { search }, window.SESSION?.access_token);
      lookup = data || [];
      const tbody = document.querySelector('#grid tbody'); tbody.innerHTML='';
      for(const r of lookup){
        const tr = document.createElement('tr'); tr.className='border-b last:border-0';
        tr.innerHTML = `
          <td class="py-2 px-3 font-mono text-xs text-slate-500">{{r.codigo}}</td>
          <td class="py-2 px-3">{{r.descricao}}</td>
          <td class="py-2 px-3">{{r.unidade||'UN'}}</td>
          <td class="py-2 px-3 text-right">{{r.estoque??0}}</td>
          <td class="py-2 px-3 text-right">{{money(r.custo_medio||0)}}</td>
          <td class="py-2 px-3 text-right">{{money(r.preco_venda||0)}}</td>`;
        tbody.appendChild(tr);
      }
    }

    function setupAutocomplete() {
      const box = document.querySelector('#produto');
      const wrap = document.querySelector('#suggest'); 
      const list = document.querySelector('#suggest ul');
      wrap.classList.add('hidden');

      function update(){
        const q = box.value.trim().toLowerCase();
        if(!q) { wrap.classList.add('hidden'); list.innerHTML=''; return; }
        const res = lookup.filter(p=> (p.codigo||'').toLowerCase().includes(q) || (p.descricao||'').toLowerCase().includes(q)).slice(0,8);
        list.innerHTML='';
        for(const p of res){
          const li = document.createElement('li');
          li.className='px-3 py-2 hover:bg-slate-100 cursor-pointer';
          li.textContent = `${p.codigo} ‚Äî ${p.descricao}`;
          li.onclick = ()=> { box.value = p.codigo; wrap.classList.add('hidden'); };
          list.appendChild(li);
        }
        wrap.classList.toggle('hidden', res.length===0);
      }

      box.addEventListener('input', debounce(update, 150));
      box.addEventListener('blur', ()=> setTimeout(()=> wrap.classList.add('hidden'), 150));
      box.addEventListener('focus', update);
    }

    async function salvarCompra(e){
      e.preventDefault();
      const f = e.target;
      const payload = {
        produto: f.produto.value.trim(),
        unidade: f.unidade.value||'UN',
        preco_venda: Number((f.preco_venda.value||'').replace(',','.'))||null,
        quantidade: Number((f.quantidade.value||'').replace(',','.'))||0,
        valor_compra: Number((f.valor_compra.value||'').replace(',','.'))||0,
        data: f.data.value||null
      };
      if(!payload.produto||!payload.quantidade||!payload.valor_compra){ toast('Preencha produto, quantidade e valor de compra','err'); return; }
      await API.post('estoque/compra', payload, window.SESSION?.access_token);
      toast('Compra registrada!');
      f.reset(); f.produto.focus(); carregarSaldos(document.querySelector('#busca').value);
    }

    async function salvarAjuste(e){
      e.preventDefault();
      const f = e.target;
      const payload = {
        produto: f.produto_aj.value.trim(),
        quantidade: Number((f.qtd.value||'').replace(',','.'))||0,
        motivo: f.motivo.value.trim()||null
      };
      if(!payload.produto||!payload.quantidade){ toast('Preencha produto e quantidade','err'); return; }
      await API.post('estoque/ajuste', payload, window.SESSION?.access_token);
      toast('Ajuste salvo!');
      f.reset(); f.produto_aj.focus(); carregarSaldos(document.querySelector('#busca').value);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelector('#form-compra').addEventListener('submit', salvarCompra);
      document.querySelector('#form-ajuste').addEventListener('submit', salvarAjuste);
      document.querySelector('#busca').addEventListener('input', debounce((e)=> carregarSaldos(e.target.value), 300));
      carregarSaldos(); setupAutocomplete();
    });
  </script>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
  <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
    <a href="/produtos.html" class="font-semibold">üç¨ Loja Doces</a>
    <nav class="flex items-center gap-3 text-sm">
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100 " href="/produtos.html">Produtos</a>
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100 " href="/clientes.html">Clientes</a>
      <a class="px-3 py-1.5 rounded-lg hover:bg-slate-100 bg-slate-100" href="/estoque.html">Estoque</a>
      <span id="user-email" class="text-slate-500"></span>
      <button id="btn-logout" type="button" class="px-3 py-1.5 rounded-lg bg-slate-100 hover:bg-slate-200">Sair</button>
    </nav>
  </div>
</header>

  <main class="mx-auto max-w-6xl px-4 py-6 grid lg:grid-cols-2 gap-6">
    <section class="lg:col-span-1">
      <div class="bg-white border rounded-2xl p-5 shadow-sm">
        <h2 class="font-medium mb-4">Nova entrada (compra)</h2>
        <form id="form-compra" class="grid gap-3">
          <div class="relative">
            <label class="text-sm text-slate-500">Produto</label>
            <input id="produto" name="produto" placeholder="Digite c√≥digo ou descri√ß√£o..." class="w-full mt-1 px-3 py-2 border rounded-xl" required>
            <div id="suggest" class="absolute left-0 right-0 top-[62px] bg-white border rounded-xl shadow hidden">
              <ul class="max-h-56 overflow-auto"></ul>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm text-slate-500">Unidade</label><input name="unidade" value="UN" class="w-full mt-1 px-3 py-2 border rounded-xl"></div>
            <div><label class="text-sm text-slate-500">Pre√ßo venda (info)</label><input name="preco_venda" placeholder="0,00" class="w-full mt-1 px-3 py-2 border rounded-xl"></div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div><label class="text-sm text-slate-500">Quantidade</label><input name="quantidade" placeholder="0" class="w-full mt-1 px-3 py-2 border rounded-xl"></div>
            <div><label class="text-sm text-slate-500">Valor compra</label><input name="valor_compra" placeholder="0,00" class="w-full mt-1 px-3 py-2 border rounded-xl"></div>
            <div><label class="text-sm text-slate-500">Data</label><input name="data" type="date" class="w-full mt-1 px-3 py-2 border rounded-xl"></div>
          </div>
          <button class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl py-2">Registrar compra</button>
          <p class="text-sm text-slate-500">A entrada atualiza o saldo do estoque automaticamente.</p>
        </form>
      </div>
    </section>
    <section class="lg:col-span-1">
      <div class="bg-white border rounded-2xl p-5 shadow-sm">
        <h2 class="font-medium mb-4">Ajuste de estoque</h2>
        <form id="form-ajuste" class="grid gap-3">
          <div><label class="text-sm text-slate-500">Produto</label><input name="produto_aj" placeholder="C√≥digo ou descri√ß√£o..." class="w-full mt-1 px-3 py-2 border rounded-xl" required></div>
          <div class="grid grid-cols-2 gap-3">
            <div><label class="text-sm text-slate-500">Quantidade (+/-)</label><input name="qtd" placeholder="ex.: -1 ou 5" class="w-full mt-1 px-3 py-2 border rounded-xl" required></div>
            <div><label class="text-sm text-slate-500">Motivo</label><input name="motivo" placeholder="Ex.: quebra, invent√°rio..." class="w-full mt-1 px-3 py-2 border rounded-xl"></div>
          </div>
          <button class="mt-2 bg-slate-900 hover:bg-slate-800 text-white rounded-xl py-2">Salvar ajuste</button>
          <p class="text-sm text-slate-500">Valores positivos adicionam; negativos subtraem.</p>
        </form>
      </div>
    </section>

    <section class="lg:col-span-2">
      <div class="bg-white border rounded-2xl p-5 shadow-sm">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium">Saldos de estoque</h2>
          <input id="busca" placeholder="Buscar por c√≥digo ou descri√ß√£o..." class="px-3 py-2 border rounded-xl w-72">
        </div>
        <div class="overflow-auto">
          <table id="grid" class="w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr>
                <th class="py-2 px-3 font-normal">C√≥digo</th>
                <th class="py-2 px-3 font-normal">Descri√ß√£o</th>
                <th class="py-2 px-3 font-normal">Un.</th>
                <th class="py-2 px-3 font-normal text-right">Estoque</th>
                <th class="py-2 px-3 font-normal text-right">Custo m√©dio</th>
                <th class="py-2 px-3 font-normal text-right">Pre√ßo venda</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</body>
</html>
